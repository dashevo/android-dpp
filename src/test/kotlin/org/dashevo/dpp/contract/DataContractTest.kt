/**
 * Copyright (c) 2020-present, Dash Core Team
 *
 * This source code is licensed under the MIT license found in the
 * COPYING file in the root directory of this source tree.
 */

package org.dashevo.dpp.contract
import org.dashevo.dpp.Fixtures
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Test

class DataContractTest {

    companion object {
        val factory = ContractFactory()
    }

    @Test
    fun testContract() {
        var contract = Fixtures.getDataContractFixtures()

        assertEquals(DataContract.SCHEMA, contract.schema)
        assertEquals(3, contract.documents.size)
        assertEquals("3eHkM3mWjutxbc3EQwnVQHyymDgbZfK4EhZRectK11jV", contract.id)
    }

    /*@Test
    fun testContactFactory() {
        var factory = ContractFactory()

        val json = File("src/test/resources/data/documentsforcontract.json").readText()//"{\r\n\"name\" : \"abc\" ,\r\n\"email id \" : [\"abc@gmail.com\",\"def@gmail.com\",\"ghi@gmail.com\"]\r\n}"
        val jsonObject = JSONObject(json)
        val map = jsonObject.toMap()

        val rawContract = HashMap<String, Any?>()
        rawContract["documents"] = map
        rawContract["contractId"] = "9rjz23TQ3rA2agxXD56XeDfw63hHJUwuj7joxSBEfRgX"
        rawContract["\$schema"] = DataContract.SCHEMA
        rawContract["definitions"] = JSONObject("{lastName: { type: 'string', }, }").toMap()

        val factoryCreatedContract = factory.createDataContract(rawContract)
        val fixtureCreatedContract = Fixtures.getDataContractFixtures()

        assertEquals(fixtureCreatedContract.id, factoryCreatedContract.id)

        val anotherFactoryCreatedContract = factory.createDataContract("9rjz23TQ3rA2agxXD56XeDfw63hHJUwuj7joxSBEfRgX", map)

        assertEquals(fixtureCreatedContract.id, anotherFactoryCreatedContract.id)
    }*/

    @Test
    fun applyStateTransition() {
        val dataContract = Fixtures.getDataContractFixtures()
        val stateTransition = ContractStateTransition(dataContract)

        val result =  factory.createStateTransition(dataContract)

        assertEquals(result.toJSON(), stateTransition.toJSON())
    }

    /*@Test
    fun dashPayContractTest() {
        val jsonDashPay = File("src/test/resources/data/dashpay-contract.json").readText()
        val jsonObject = JSONObject(jsonDashPay)
        val rawContract = jsonObject.toMap()

        val serializedHexData = "a169646f63756d656e7473a266646f6d61696ea467696e646963657383a26a70726f7065727469657381a1686e616d65486173686361736366756e69717565f5a16a70726f7065727469657382a1781a6e6f726d616c697a6564506172656e74446f6d61696e4e616d6563617363a16f6e6f726d616c697a65644c6162656c63617363a16a70726f7065727469657381a1747265636f7264732e646173684964656e74697479636173636a70726f70657274696573a6686e616d6548617368a4647479706566737472696e67696d696e4c656e6774681844696d61784c656e6774681844677061747465726e755e5b303132333435363738396162636465665d2b24656c6162656ca4647479706566737472696e67677061747465726e78265e28283f212d295b612d7a412d5a302d392d5d7b302c36327d5b612d7a412d5a302d395d2924696d696e4c656e67746803696d61784c656e67746818286f6e6f726d616c697a65644c6162656ca4647479706566737472696e67677061747465726e78205e28283f212d295b612d7a302d392d5d7b302c36327d5b612d7a302d395d2924696d696e4c656e67746803696d61784c656e6774681828781a6e6f726d616c697a6564506172656e74446f6d61696e4e616d65a3647479706566737472696e67696d696e4c656e67746800696d61784c656e67746818286c7072656f7264657253616c74a3647479706566737472696e67696d696e4c656e67746801696d61784c656e6774681844677265636f726473a46474797065666f626a6563746a70726f70657274696573a16c646173684964656e74697479a4647479706566737472696e67696d696e4c656e677468182a696d61784c656e677468182c677061747465726e783f5e5b31323334353637383941424344454647484a4b4c4d4e505152535455565758595a6162636465666768696a6b6d6e6f707172737475767778797a5d2b246d6d696e50726f7065727469657301746164646974696f6e616c50726f70657274696573f468726571756972656486686e616d6548617368656c6162656c6f6e6f726d616c697a65644c6162656c781a6e6f726d616c697a6564506172656e74446f6d61696e4e616d656c7072656f7264657253616c74677265636f726473746164646974696f6e616c50726f70657274696573f4687072656f72646572a467696e646963657381a26a70726f7065727469657381a17073616c746564446f6d61696e486173686361736366756e69717565f56a70726f70657274696573a17073616c746564446f6d61696e48617368a4647479706566737472696e67696d696e4c656e6774681840696d61784c656e6774681844677061747465726e755e5b303132333435363738396162636465665d2b24687265717569726564817073616c746564446f6d61696e48617368746164646974696f6e616c50726f70657274696573f4"
        val serializedData = HashUtils.fromHex(serializedHexData)

        val serializedFromRaw = Cbor.encode(rawContract)


        val fromRaw = factory.createFromObject(rawContract)

        val fromSerialized = factory.createFromSerialized(serializedData)
        val fromRoundTrip = factory.createFromSerialized(fromRaw.serialize())
        assertEquals(fromRaw.toJSON(), fromRoundTrip.toJSON())
        assertEquals(fromRaw.toJSON(), fromSerialized.toJSON())
        assertEquals(fromRaw.serialize().toHexString(), fromRoundTrip.serialize().toHexString())
        assertEquals(fromRaw.serialize().toHexString(), fromSerialized.serialize().toHexString())
        val fromRawData = factory.createDataContract(rawContract)
    }

    @Test
    fun contractFromCborTest() {
        val contractBytes = "a46724736368656d61783468747470733a2f2f736368656d612e646173682e6f72672f6470702d302d342d302f6d6574612f646174612d636f6e74726163746776657273696f6e0169646f63756d656e7473a266646f6d61696ea467696e646963657383a266756e69717565f56a70726f7065727469657381a1686e616d654861736863617363a16a70726f7065727469657382a1781a6e6f726d616c697a6564506172656e74446f6d61696e4e616d6563617363a16f6e6f726d616c697a65644c6162656c63617363a16a70726f7065727469657381a1747265636f7264732e646173684964656e746974796361736368726571756972656486686e616d6548617368656c6162656c6f6e6f726d616c697a65644c6162656c781a6e6f726d616c697a6564506172656e74446f6d61696e4e616d656c7072656f7264657253616c74677265636f7264736a70726f70657274696573a6656c6162656ca4647479706566737472696e67677061747465726e78265e28283f212d295b612d7a412d5a302d392d5d7b302c36327d5b612d7a412d5a302d395d2924696d61784c656e677468183f6b6465736372697074696f6e7819446f6d61696e206c6162656c2e20652e672e20275573655227677265636f726473a46474797065666f626a6563746a70726f70657274696573a16c646173684964656e74697479a5647479706566737472696e67677061747465726e783f5e5b31323334353637383941424344454647484a4b4c4d4e505152535455565758595a6162636465666768696a6b6d6e6f707172737475767778797a5d2b24696d61784c656e677468182c696d696e4c656e677468182a6b6465736372697074696f6e7819626173653538206964656e7469747920696420737472696e676d6d696e50726f7065727469657301746164646974696f6e616c50726f70657274696573f4686e616d6548617368a5647479706566737472696e67677061747465726e6e5e5b412d46612d66302d395d2b24696d61784c656e6774681844696d696e4c656e67746818446b6465736372697074696f6e784a446f75626c65207368612d323536206d756c746968617368206f66207468652066756c6c20646f6d61696e206e616d6520696e206120666f726d206f6620612068657820737472696e676c7072656f7264657253616c74a5647479706566737472696e67677061747465726e783f5e5b31323334353637383941424344454647484a4b4c4d4e505152535455565758595a6162636465666768696a6b6d6e6f707172737475767778797a5d2b24696d61784c656e6774681822696d696e4c656e67746818196b6465736372697074696f6e784a446f6d61696e207072652d6f726465722073616c742e2043757272656e746c792072616e646f6d6c792067656e65726174656420626173653538206164647265737320737472696e672e6f6e6f726d616c697a65644c6162656ca4647479706566737472696e67677061747465726e78205e28283f212d295b612d7a302d392d5d7b302c36327d5b612d7a302d395d2924696d61784c656e677468183f6b6465736372697074696f6e7829446f6d61696e206c6162656c20696e2061206c6f77657220636173652e20652e672e20277573657227781a6e6f726d616c697a6564506172656e74446f6d61696e4e616d65a4647479706566737472696e67696d61784c656e67746818be696d696e4c656e677468006b6465736372697074696f6e7838412066756c6c20706172656e7420646f6d61696e206e616d6520696e206c6f77657220636173652e20652e672e2027646173682e6f726727746164646974696f6e616c50726f70657274696573f4687072656f72646572a467696e646963657381a266756e69717565f56a70726f7065727469657381a17073616c746564446f6d61696e4861736863617363687265717569726564817073616c746564446f6d61696e486173686a70726f70657274696573a17073616c746564446f6d61696e48617368a5647479706566737472696e67677061747465726e6e5e5b412d46612d66302d395d2b24696d61784c656e6774681844696d696e4c656e67746818446b6465736372697074696f6e7851446f75626c65207368612d323536206d756c746968617368206f66207468652066756c6c20646f6d61696e206e616d65202b2073616c7420696e206120666f726d206f6620612068657820737472696e67746164646974696f6e616c50726f70657274696573f46a636f6e74726163744964782c3737773858716e323548774a686a6f647248573133336158686a7554735476396f7a51615970534841434533"

        val contract = factory.createFromSerialized(HashUtilsTest.fromHex(contractBytes))
        val jsonDashPay = File("src/test/resources/data/dpns-contract.json").readText()
        val jsonObject = JSONObject(jsonDashPay)
        val rawContract = jsonObject.toMap()

        val contractFromJson = DataContract(rawContract)
        assertEquals(contract.toJSON(), contractFromJson.toJSON())
    }
*/
    @Test
    fun verifyLoadingContractFromFile() {
        val dataContractST = Fixtures.getDataContractSTSignedFixture()
        val dataContractSTTwo = Fixtures.getDataContractSTSignedFixtureTwo()
        assertEquals("EzLBmQdQXYMaoeXWNaegK18iaaCDShitN3s14US3DunM", dataContractST.dataContract.id)
        assertEquals(dataContractST.signature, dataContractSTTwo.signature)
    }

//    @Test
//    fun verifySignedDataContractSTTest() {
//        val dataContractST = Fixtures.getDataContractSTSignedFixture()
//        var identity = Fixtures.getIdentityForSignaturesFixture()
//
//        assertTrue(dataContractST.verifySignature(identity.publicKeys[0]))
//
//        val dataContractSTTwo = Fixtures.getDataContractSTSignedFixtureTwo();
//        assertEquals(dataContractST.toJSON(), dataContractSTTwo.toJSON())
//    }
}
